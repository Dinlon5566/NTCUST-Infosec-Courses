<?php
session_start();
function generateRandomString($length = 20) {
    $characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    $charactersLength = strlen($characters);
    $randomString = '';
    for ($i = 0; $i < $length; $i++) {
        $randomString .= $characters[rand(0, $charactersLength - 1)];
    }
    return $randomString;
}

// 若尚未產生優惠券代碼，則先產生並存入 session
if (!isset($_SESSION['coupon_codes'])) {
    // 隨機產生 20 字元字串

    // 產生有效代碼
    $validCode = generateRandomString(20);
    // 產生 9 個假代碼
    $dummyCodes = [];
    for ($i = 0; $i < 9; $i++) {
        $dummyCodes[] = generateRandomString(20);
    }
    // 合併並隨機排序一次，並存入 session 中（後續提交時保持不變）
    $couponCodes = array_merge($dummyCodes, [$validCode]);
    shuffle($couponCodes);
    $_SESSION['coupon_codes'] = $couponCodes;
    $_SESSION['valid_coupon'] = $validCode;
} else {
    $couponCodes = $_SESSION['coupon_codes'];
    $validCode = $_SESSION['valid_coupon'];
}

$message = "";
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $inputCode = isset($_POST['code']) ? trim($_POST['code']) : "";
    if ($inputCode === $validCode) {
        // 產生一個新的優惠碼
        $cupon = generateRandomString(10);
        $_SESSION['discount_coupon'] = $cupon;
        $message = "代碼有效！您的優惠碼為：".$cupon." (僅可使用一次)";
    } else {
        $message = "代碼無效！已被使用或不存在。";
    }
}
?>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>領取優惠碼 - 企鵝商店5</title>
    <style>
        body {
            background: #eef2f3;
            font-family: Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .coupon-container {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            width: 500px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .code-list {
            margin: 20px 0;
            padding: 0;
            list-style: none;
        }
        .code-list li {
            font-family: monospace;
            background: #f7f7f7;
            margin: 5px 0;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form {
            text-align: center;
        }
        input[type="text"] {
            width: 80%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        button {
            background: #5cb85c;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #4cae4c;
        }
        .message {
            text-align: center;
            font-size: 16px;
            color: #d9534f;
            margin-top: 15px;
        }
        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            text-decoration: none;
            color: #337ab7;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
    <script>
        document.addEventListener('keydown', function(e) {
            if (e.keyCode === 123) {
                e.preventDefault();
            }
        });
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        window.addEventListener('load', function(){
            var input = document.getElementsByName("code")[0];
            input.onpaste = function(e){ e.preventDefault(); return false; };
            input.oncopy = function(e){ e.preventDefault(); return false; };
            input.oncut = function(e){ e.preventDefault(); return false; };
        });
    </script>
</head>
<body>
    <div class="coupon-container">
        <h1>領取優惠碼</h1>
        <p>下列為十個 20 字元的代碼，請從中輸入一個：</p>
        <ul class="code-list">
            <?php foreach ($couponCodes as $code): ?>
                <li><?php echo htmlspecialchars($code); ?></li>
            <?php endforeach; ?>
        </ul>
        <form method="POST" action="coupon.php">
            <input type="text" name="code" placeholder="輸入代碼" autocomplete="off">
            <button type="submit">驗證代碼</button>
        </form>
        <?php if ($message): ?>
            <p class="message"><?php echo htmlspecialchars($message); ?></p>
        <?php endif; ?>
        <a class="back-link" href="index.php">返回商店</a>
    </div>
</body>
</html>
